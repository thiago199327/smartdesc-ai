<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Honra - Elo Digital</title>
    <style>
        :root { --primary: #7B2CBF; --secondary: #E63946; --glass: rgba(255, 255, 255, 0.8); }
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0; height: 100vh; display: flex; flex-direction: column;
        }

        /* Cabe√ßalho */
        .chat-header { padding: 20px; text-align: center; background: var(--glass); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .chat-header h2 { margin: 0; color: var(--primary); font-size: 1.2rem; }

        /* √Årea de Mensagens */
        #chatBox { 
            flex-grow: 1; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; gap: 15px;
            padding-bottom: 100px;
        }

        .msg { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 0.95rem; position: relative; animation: fadeIn 0.3s ease; }
        .msg.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 5px; }
        .msg.received { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .msg small { display: block; font-size: 0.65rem; margin-bottom: 4px; opacity: 0.7; font-weight: bold; }
        
        /* Bot√£o de Den√∫ncia */
        .btn-denunciar { 
            position: absolute; top: -10px; right: -10px; 
            background: var(--secondary); color: white; border: none; 
            width: 20px; height: 20px; border-radius: 50%; 
            font-size: 0.7rem; cursor: pointer; display: none;
        }
        .msg.received:hover .btn-denunciar { display: block; }

        /* Barra de Digita√ß√£o */
        .input-area { 
            position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; display: flex; gap: 10px;
            background: var(--glass); backdrop-filter: blur(15px);
            padding: 10px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        input { flex-grow: 1; border: none; background: transparent; padding: 10px; outline: none; font-size: 1rem; }
        .btn-send { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }

        /* Menu de Navega√ß√£o */
        .nav-menu { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); display: flex; justify-content: space-around; align-items: center; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-decoration: none; color: #888; font-size: 1.5rem; }
        .nav-item.active { color: var(--primary); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="chat-header">
        <h2>üí¨ Chat de Honra</h2>
    </div>

    <div id="chatBox">
        </div>

    <div class="input-area">
        <input type="text" id="inputMsg" placeholder="Sua palavra tem valor...">
        <button class="btn-send" onclick="enviar()">‚û§</button>
    </div>

    <div class="nav-menu">
        <a href="index.html" class="nav-item">üè†</a>
        <a href="biblioteca.html" class="nav-item">üìö</a>
        <a href="explorar.html" class="nav-item">üåé</a>
        <a href="chat.html" class="nav-item active">üí¨</a>
        <a href="perfil.html" class="nav-item">üë§</a>
    </div>

    <script>
        const BASE_URL = "https://thiago19932-elo-digital-33.deno.dev";
        const usuarioLogado = localStorage.getItem('usuarioLogado') || "Visitante";

        async function carregarMensagens() {
            const res = await fetch(`${BASE_URL}/mensagens`);
            const mensagens = await res.json();
            const box = document.getElementById('chatBox');
            box.innerHTML = "";

            mensagens.forEach(m => {
                const div = document.createElement('div');
                const isEu = m.autor === usuarioLogado;
                div.className = `msg ${isEu ? 'sent' : 'received'}`;
                div.innerHTML = `
                    <small>${m.autor}</small>
                    ${m.texto}
                    ${!isEu ? `<button class="btn-denunciar" onclick="denunciar('${m.id}')">!</button>` : ''}
                `;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        async function enviar() {
            const input = document.getElementById('inputMsg');
            const texto = input.value;
            if(!texto) return;

            await fetch(`${BASE_URL}/mensagens`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ autor: usuarioLogado, texto: texto })
            });

            input.value = "";
            carregarMensagens();
        }

        async function denunciar(msgId) {
            if(confirm("Deseja que a I.A. analise esta mensagem por falta de honra?")) {
                const res = await fetch(`${BASE_URL}/ia/denunciar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: msgId })
                });
                const data = await res.json();
                alert("Resultado da I.A.: " + data.veredito);
            }
        }

        setInterval(carregarMensagens, 3000); // Atualiza a cada 3 segundos
        carregarMensagens();
    </script>
</body>
</html>
